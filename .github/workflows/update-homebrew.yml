name: Update Homebrew tap

on:
  release:
    types: [published]

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Get release info
        id: release
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/${GITHUB_REF_NAME}.tar.gz"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: Download tarball and compute SHA256
        id: sha
        run: |
          URL="${{ steps.release.outputs.url }}"
          curl -sL "$URL" -o source.tar.gz
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"

      - name: Render formula
        run: |
          python scripts/render_homebrew_formula.py \
            --version "${{ steps.release.outputs.version }}" \
            --homepage "https://github.com/${{ github.repository }}" \
            --url "${{ steps.release.outputs.url }}" \
            --sha256 "${{ steps.sha.outputs.sha256 }}" \
            --output formula.rb

      - name: Push to homebrew-tap
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone https://x-access-token:${TAP_TOKEN}@github.com/liamvinberg/homebrew-tap.git tap
          mkdir -p tap/Formula
          cp formula.rb tap/Formula/ica-cli.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/ica-cli.rb
          if git diff --cached --quiet; then
            echo "No formula changes"
          else
            git commit -m "ica-cli ${{ steps.release.outputs.version }}"
            git push
          fi
